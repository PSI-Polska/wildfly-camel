<?xml version="1.0" encoding="UTF-8"?>

<!-- ====================================================================== -->
<!--                                                                        -->
<!--  JBoss, the OpenSource J2EE webOS                                      -->
<!--                                                                        -->
<!--  Distributable under LGPL license.                                     -->
<!--  See terms of license at http://www.gnu.org.                           -->
<!--                                                                        -->
<!-- ====================================================================== -->

<project>

  <!-- ================================================================== -->
  <!-- Setup                                                              -->
  <!-- ================================================================== -->
  
  <property name="output.dir" value="${basedir}/target" />
  <property name="resources.dir" value="${basedir}/src/main/resources" />
  <property name="filtered.resources.dir" value="${output.dir}/resources" />
  <property name="deploy.artifacts.dir" value="${output.dir}/deploy-artifacts" />
  <property name="deploy.artifacts.lib" value="${deploy.artifacts.dir}/lib" />
  <property name="deploy.artifacts.resources" value="${deploy.artifacts.dir}/resources" />

  <!-- ================================================================== -->
  <!-- Initialization                                                     -->
  <!-- ================================================================== -->
  <target name="init">
  </target>

  <!-- ================================================================== -->
  <!-- Distribution                                                       -->
  <!-- ================================================================== -->
  <target name="build-installer" depends="init">

  	<!-- Filter the installer resources -->
    <copy todir="${filtered.resources.dir}" filtering="true" overwrite="true">
        <fileset dir="${resources.dir}/installer" />
      <filterset>
        <filter token="installpath" value="${output.dir}/auto-install-dest" />
        <filter token="wildfly.server.target" value="${wildfly.server.target}" />
        <filter token="wildfly.home" value="${wildfly.home}" />
      </filterset>
    </copy>
    <copy todir="${deploy.artifacts.resources}/modules" filtering="true" overwrite="true">
        <fileset dir="${resources.dir}/modules" />
      <filterset>
        <filter token="project.version" value="${project.version}" />
        <filter token="version.apache.camel" value="${version.apache.camel}" />
        <filter token="version.apache.spring" value="${version.apache.spring}" />
      </filterset>
    </copy>
  	
    <!-- Define the IzPack Ant task -->
    <taskdef name="izpack" classname="com.izforge.izpack.ant.IzPackTask">
      <classpath>
        <pathelement path="${maven.runtime.classpath}" />
      </classpath>
    </taskdef>
    <property name="izpack.temp.dir" value="${output.dir}/izpack-temp" />
    <mkdir dir="${izpack.temp.dir}" />

    <!-- Run installer build -->
    <echo message="Running IzPack to build the installer..." />
    <izpack input="${resources.dir}/installer/install-definition.xml" output="${output.dir}/wildfly-camel-installer-${product.version}.jar"
      installerType="standard" inheritAll="true" basedir="${izpack.temp.dir}" />

    <!-- Clean working directory -->
    <delete dir="${izpack.temp.dir}" quiet="true" includeemptydirs="true" />
  </target>
</project>